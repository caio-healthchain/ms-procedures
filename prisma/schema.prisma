// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Patient {
  id                    String            @id @default(cuid())
  fullName              String
  email                 String?
  phone                 String?
  birthDate             DateTime?
  
  // Relacionamentos
  procedures            Procedure[]
  
  // Auditoria
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  deletedAt             DateTime?
  
  @@map("patients")
}

model Hospital {
  id                    String            @id
  name                  String
  cnpj                  String?
  address               String?
  phone                 String?
  email                 String?
  
  // Relacionamentos
  procedures            Procedure[]
  
  // Auditoria
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  
  @@map("hospitals")
}

model Procedure {
  id                    String            @id @default(cuid())
  code                  String
  name                  String
  description           String?
  category              ProcedureCategory
  subcategory           String?
  suggestedPort         Int
  actualPort            Int?
  status                ProcedureStatus   @default(SCHEDULED)
  scheduledDate         DateTime?
  performedDate         DateTime?
  duration              Int? // em minutos
  estimatedDuration     Int? // em minutos
  basePrice             Decimal?          @db.Decimal(10, 2)
  complexity            ProcedureComplexity
  anesthesiaType        AnesthesiaType?
  preOperativeExams     String[]
  postOperativeInstructions String?
  complications         String?
  notes                 String?
  requiresAuthorization Boolean           @default(false)
  tags                  String[]
  
  // Relacionamentos
  patientId             String
  patient               Patient           @relation(fields: [patientId], references: [id], onDelete: Cascade)
  hospitalId            String            @default("hosp_sagrada_familia_001")
  hospital              Hospital          @relation(fields: [hospitalId], references: [id])
  surgicalTeam          SurgicalTeamMember[]
  materials             ProcedureMaterial[]
  portValidations       PortValidation[]
  
  // Auditoria
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  deletedAt             DateTime?
  
  @@map("procedures")
}

model SurgicalTeamMember {
  id          String        @id @default(cuid())
  name        String
  role        SurgicalRole
  crm         String?
  specialty   String?
  
  // Relacionamentos
  procedureId String
  procedure   Procedure     @relation(fields: [procedureId], references: [id], onDelete: Cascade)
  
  @@map("surgical_team_members")
}

model ProcedureMaterial {
  id              String        @id @default(cuid())
  code            String
  name            String
  quantity        Int
  unitPrice       Decimal       @db.Decimal(10, 2)
  totalPrice      Decimal       @db.Decimal(10, 2)
  supplier        String?
  batchNumber     String?
  expirationDate  DateTime?
  status          MaterialStatus @default(REQUESTED)
  
  // Relacionamentos
  procedureId     String
  procedure       Procedure     @relation(fields: [procedureId], references: [id], onDelete: Cascade)
  
  // Auditoria
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@map("procedure_materials")
}

model PortValidation {
  id              String    @id @default(cuid())
  suggestedPort   Int
  actualPort      Int
  isValid         Boolean
  discrepancy     Int
  reason          String?
  validatedBy     String?
  validatedAt     DateTime?
  
  // Relacionamentos
  procedureId     String
  procedure       Procedure @relation(fields: [procedureId], references: [id], onDelete: Cascade)
  
  // Auditoria
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@map("port_validations")
}

model PortValidationRule {
  id                String              @id @default(cuid())
  procedureCode     String              @unique
  procedureName     String
  category          ProcedureCategory
  complexity        ProcedureComplexity
  minimumPort       Int
  maximumPort       Int
  recommendedPort   Int
  factors           Json // Array of PortFactor
  isActive          Boolean             @default(true)
  
  // Auditoria
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  @@map("port_validation_rules")
}

model MaterialRequest {
  id            String                @id @default(cuid())
  procedureId   String
  materialCode  String
  materialName  String
  quantity      Int
  urgency       MaterialUrgency       @default(MEDIUM)
  requestedBy   String
  requestedAt   DateTime              @default(now())
  approvedBy    String?
  approvedAt    DateTime?
  status        MaterialRequestStatus @default(PENDING)
  notes         String?
  
  // Auditoria
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  
  @@map("material_requests")
}

// Enums
enum ProcedureCategory {
  GENERAL_SURGERY
  CARDIAC_SURGERY
  ORTHOPEDIC_SURGERY
  NEUROSURGERY
  PLASTIC_SURGERY
  GYNECOLOGICAL_SURGERY
  UROLOGICAL_SURGERY
  OPHTHALMOLOGICAL_SURGERY
  OTOLARYNGOLOGICAL_SURGERY
  VASCULAR_SURGERY
  THORACIC_SURGERY
  PEDIATRIC_SURGERY
  EMERGENCY_SURGERY
  DIAGNOSTIC_PROCEDURE
  THERAPEUTIC_PROCEDURE
}

enum ProcedureStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  POSTPONED
  PENDING_APPROVAL
  APPROVED
  REJECTED
}

enum ProcedureComplexity {
  LOW
  MEDIUM
  HIGH
  VERY_HIGH
  PORTE_1
  PORTE_2
  PORTE_3
  PORTE_4
  PORTE_ESPECIAL
}

enum AnesthesiaType {
  LOCAL
  REGIONAL
  GENERAL
  SEDATION
  NONE
}

enum SurgicalRole {
  MAIN_SURGEON
  ASSISTANT_SURGEON
  ANESTHESIOLOGIST
  NURSE
  TECHNICIAN
  RESIDENT
}

enum MaterialStatus {
  REQUESTED
  APPROVED
  DELIVERED
  USED
  RETURNED
  EXPIRED
  REJECTED
}

enum MaterialUrgency {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum MaterialRequestStatus {
  PENDING
  APPROVED
  REJECTED
  ORDERED
  DELIVERED
  CANCELLED
}



model AuditLog {
  id            String    @id @default(cuid())
  action        String
  entity        String
  entityId      String
  userId        String
  userName      String
  userRole      String
  oldValues     Json?
  newValues     Json?
  patientId     String?
  procedureId   String?
  
  // Auditoria
  createdAt     DateTime  @default(now())
  
  @@map("audit_logs")
}
